/*  *
 *   Copyright 2013 American Public Media Group
 *
 *   This file is part of AIR2.
 *
 *   AIR2 is free software: you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *   (at your option) any later version.
 *
 *   AIR2 is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   You should have received a copy of the GNU General Public License
 *   along with AIR2.  If not, see <http://www.gnu.org/licenses/>.
 *

 */(function($){var defaultOptions={slides:[],mapType:'mapquest',apiKey:null,center:[40.423,-98.7372],zoom:4,minZoom:2,maxZoom:10,keyEvents:true,closePopupOnClick:false,mapPosition:'bottom',mapHeight:400,slideHeight:220,autoHeight:false,leafPile:false,animateSpeed:200,controlType:'sides'};var DATA;var $THIS;function _slideOut($el,goLeft){var end=goLeft?-($el.width()):$el.width();$el.animate({'margin-left':end},DATA.options.animateSpeed,'swing',function(){$el.removeClass('active').removeAttr('style');});}
function _slideIn($el,goLeft){var start=goLeft?$el.width():-($el.width());$el.css('margin-left',start).addClass('active');$el.animate({'margin-left':0},DATA.options.animateSpeed,'swing',function(){$el.removeAttr('style');});_autoHeight($el,true);}
function _refreshControls(){var left=$THIS.find('.ctrl-left'),right=$THIS.find('.ctrl-right'),count=$THIS.find('.ctrl-count');(DATA.index>0)?left.addClass('active'):left.removeClass('active');(DATA.index<DATA.items.length-1)?right.addClass('active'):right.removeClass('active');count.html((DATA.index===null?0:DATA.index+1)+' of '+DATA.items.length);}
function _autoHeight($el,animate){if(DATA.options.autoHeight){var $show=$THIS.find('.smapp-show');if(!DATA.autoHeight)DATA.autoHeight=$show.height();var inner=$el.find('.slide-inner').height(),outer=$show.height();if(inner>outer){animate?$show.animate({'height':inner},DATA.options.animateSpeed):$show.height(inner);}
else if(inner<outer){var newH=Math.max(inner,DATA.autoHeight);animate?$show.animate({'height':newH},DATA.options.animateSpeed):$show.height(newH);}}}
function _onKeyPress(e){if(DATA.index!==null){if(e.keyCode==37)$THIS.slideMapper('prev');if(e.keyCode==39)$THIS.slideMapper('next');}}
function _setTiles(tileType){if(DATA.tileLayer){DATA.map.removeLayer(DATA.tileLayer);DATA.tileLayer=false;}
if(tileType=='cloudmade'){if(!DATA.options.apiKey)$.error('apiKey required for cloudmade tiles');var tileOpts={attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>'};DATA.tileLayer=new L.TileLayer('http://{s}.tile.cloudmade.com/'+DATA.options.apiKey+'/997/256/{z}/{x}/{y}.png',tileOpts);}
else if(tileType=='stamen-toner'){if(!L.StamenTileLayer)$.error('did you forget to include tile.stamen.js?');DATA.tileLayer=new L.StamenTileLayer('toner');}
else if(tileType=='stamen-terrain'){if(!L.StamenTileLayer)$.error('did you forget to include tile.stamen.js?');DATA.tileLayer=new L.StamenTileLayer('terrain');}
else if(tileType=='stamen-watercolor'){if(!L.StamenTileLayer)$.error('did you forget to include tile.stamen.js?');DATA.tileLayer=new L.StamenTileLayer('watercolor');}
else if(tileType=='mapquest'){var tileOpts={subdomains:['otile1','otile2','otile3','otile4'],attribution:'Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="https://developer.mapquest.com/content/osm/mq_logo.png">'};DATA.tileLayer=new L.TileLayer('https://{s}-s.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png',tileOpts);}
else if(tileType=='mapquest-aerial'){var tileOpts={subdomains:['oatile1','oatile2','oatile3','oatile4'],attribution:'Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="https://developer.mapquest.com/content/osm/mq_logo.png">'};DATA.tileLayer=new L.TileLayer('https://{s}-s.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png',tileOpts);}
else{$.error('invalid tile type: '+tileType);}
DATA.map.addLayer(DATA.tileLayer);}
function _makeHTML(opts){var map,mapStyle='style="height:'+opts.mapHeight+'px"';if(opts.mapPosition==='top'){map='<div class="smapp-map top" '+mapStyle+'></div>';}
else if(opts.mapPosition==='bottom'){map='<div class="smapp-map bottom" '+mapStyle+'></div>';}
else{$.error('Invalid mapPosition: '+opts.mapPosition);}
var show=opts.autoHeight?'<div class="smapp-show" style="min-height:'+opts.slideHeight+'px">':'<div class="smapp-show" style="height:'+opts.slideHeight+'px">';show+='<div class="smapp-slides-ct"></div>';if(opts.controlType==='sides'){show+='<span class="ctrl-left ctrl-side">&lsaquo;</span>';show+='<span class="ctrl-right ctrl-side">&rsaquo;</span>';}
else if(opts.controlType==='top'){show+='<div class="ctrl-top">';show+='<span class="ctrl-left">&lsaquo;</span>';show+='<span class="ctrl-count">0 of 0</span>';show+='<span class="ctrl-right">&rsaquo;</span>';show+='</div>';}
else{$.error('Invalid controlType: '+opts.controlType);}
show+='</div>';var s='<div class="smapp">';s+=(opts.mapPosition==='top')?map:'';s+=show;s+=(opts.mapPosition==='bottom')?map:'';return s;}
function _showPopup(item,panTo){DATA.map.closePopup();if(item.marker&&item.config.popup){if(item.marker._leafpile){item.marker.openPopup();}
else{var popup=item.marker._popup.setLatLng(item.marker.getLatLng());DATA.map.openPopup(popup);}}
DATA.map.setView(item.center,item.zoom||DATA.map.getZoom(),panTo?false:true);}
function _getMarkerLayer(){var markerLayer;if(DATA.options.leafPile){if(!L.LeafpileGroup)$.error('Did you forget to include leafpile.js?');var opts=DATA.options.leafPile===true?{}:DATA.options.leafPile;markerLayer=new L.LeafpileGroup(opts);markerLayer.on('redraw',function(e){if(DATA.index!==null&&DATA.items[DATA.index].config.popup){DATA.items[DATA.index].marker.openPopup();}});markerLayer.on('click',function(e){if(e.leafpile){var idx=e.markers[0].index;if(idx!=DATA.index){if(DATA.index!==null)_slideOut(DATA.items[DATA.index].$slide,(idx>DATA.index));_slideIn(DATA.items[idx].$slide,(idx>DATA.index));DATA.index=idx;_refreshControls();}}
if(e.zooming&&DATA.frozen){e.cancelZoom();}});}
else{markerLayer=new L.LayerGroup();}
return markerLayer;}
var methods={init:function(passedOpts){if(!DATA){DATA={};DATA.options=$.extend({},defaultOptions,passedOpts);methods.options(passedOpts||{});}},options:function(passedOpts){if(passedOpts===undefined){return DATA.options;}
else{DATA.options=$.extend({},DATA.options,passedOpts);$THIS.empty();$THIS.append(_makeHTML(DATA.options));showEl=$('.smapp-show',$THIS)[0];mapEl=$('.smapp-map',$THIS)[0];$(showEl)
.on('click','.ctrl-left',function(){$THIS.slideMapper('prev');})
.on('click','.ctrl-right',function(){$THIS.slideMapper('next');});methods.keyEvents(DATA.options.keyEvents);DATA.options.center=new L.LatLng(DATA.options.center[0],DATA.options.center[1]);DATA.map=new L.Map(mapEl,DATA.options);_setTiles(DATA.options.mapType);DATA.markergroup=_getMarkerLayer();DATA.map.addLayer(DATA.markergroup);DATA.items=[];DATA.index=null;methods.add(DATA.options.slides);}},keyEvents:function(turnOn){$(document).unbind('keydown',_onKeyPress);if(turnOn){$(document).keydown(_onKeyPress)}},mapEvents:function(turnOn){var props=['dragging','touchZoom','doubleClickZoom','scrollWheelZoom','boxZoom'];var fn=turnOn?'enable':'disable';for(var i=0;i<props.length;i++){var p=props[i];if(DATA.map[p]&&typeof(DATA.map[p][fn])==='function'){DATA.map[p][fn]();}}},freeze:function(makeFrozen){DATA.frozen=makeFrozen;makeFrozen?methods.keyEvents(false):methods.keyEvents(true);},count:function(){return DATA.items.length;},get:function(index){index=(index===undefined||index===null)?DATA.index:index;return(DATA.items[index]===undefined)?false:DATA.items[index];},add:function(cfg){var idx=(DATA.items&&DATA.items.length)?DATA.items.length:0;return methods.insert(idx,cfg);},insert:function(index,cfg){if($.isArray(cfg)){var ins=[];$.each(cfg,function(i,c){ins.push(methods.insert.call(this,index+i,c));});return ins;}
if(!$.isNumeric(index)||index<0||index>DATA.items.length){$.error('Invalid index "'+index+'" provided to insert');}
var item={index:index,config:cfg};if(cfg.marker){var latlng=new L.LatLng(cfg.marker[0],cfg.marker[1]);item.marker=new L.Marker(latlng);if(cfg.popup)item.marker.bindPopup(cfg.popup);item.marker.index=index;item.marker.on('click',function(e){var idx=e.target.index;if(!DATA.frozen&&DATA.index!=idx&&$THIS.triggerHandler('move',[methods.get(idx),idx])!==false){if(DATA.index!==null)_slideOut(DATA.items[DATA.index].$slide,(idx>DATA.index));_slideIn(DATA.items[idx].$slide,(idx>DATA.index));DATA.index=idx;_refreshControls();}});DATA.markergroup.addLayer(item.marker);}
var html='<div class="slide"><div class="slide-inner">'+(cfg.html||'')+'</div></div>';if(index==DATA.items.length){item.$slide=$(html).appendTo($THIS.find('.smapp-slides-ct'));}
else{item.$slide=$(html).insertBefore(DATA.items[index].$slide);}
item.zoom=item.marker?cfg.zoom:DATA.options.zoom;item.center=item.marker?item.marker.getLatLng():DATA.options.center;if(cfg.center){item.center=new L.LatLng(cfg.center[0],cfg.center[1]);}
DATA.items.splice(index,0,item);for(var i=index+1;i<DATA.items.length;i++){DATA.items[i].index++;if(DATA.items[i].marker)DATA.items[i].marker.index++;}
if(DATA.items.length==1){methods.move(0,false);}
else if(DATA.index===index){DATA.index++;}
_refreshControls();return item;},shuffle:function(index1,index2){var fidx=(index2===undefined||index2===null)?DATA.index:index1;var item=methods.get(fidx);if(!item){$.error('Invalid from index "'+fidx+'" provided to remove');}
var tidx=(index2===undefined||index2===null)?index1:index2;if(tidx=='first')tidx=0;if(tidx=='last')tidx=DATA.items.length-1;if(!$.isNumeric(tidx)||tidx<0||tidx>DATA.items.length-1){$.error('Invalid to index "'+tidx+'" provided to insert');}
if(fidx==tidx)return;DATA.items.splice(fidx,1);for(var i=fidx;i<DATA.items.length;i++){DATA.items[i].index--;if(DATA.items[i].marker)DATA.items[i].marker.index--;}
if(tidx==DATA.items.length){item.$slide.appendTo($THIS.find('.smapp-slides-ct'));}
else{item.$slide.insertBefore(DATA.items[tidx].$slide);}
item.index=tidx;if(item.marker)item.marker.index=tidx;DATA.items.splice(tidx,0,item);for(var i=tidx+1;i<DATA.items.length;i++){DATA.items[i].index++;if(DATA.items[i].marker)DATA.items[i].marker.index++;}
if(DATA.index==fidx){DATA.index=tidx;}
_refreshControls();return item;},remove:function(index){var item=methods.get(index);if(!item){$.error('Invalid index "'+index+'" provided to remove');}
if(DATA.items.length==1){return methods.removeAll();}
if(item.marker){DATA.markergroup.removeLayer(item.marker);}
item.$slide.remove();DATA.items.splice(item.index,1);for(var i=item.index;i<DATA.items.length;i++){DATA.items[i].index--;if(DATA.items[i].marker)DATA.items[i].marker.index--;}
if(DATA.index===item.index){var flipTo=Math.min(item.index,DATA.items.length-1);_slideIn(DATA.items[flipTo].$slide,(flipTo>=DATA.index));_showPopup(DATA.items[flipTo],true);DATA.index=flipTo;}
_refreshControls();},removeAll:function(){DATA.map.removeLayer(DATA.markergroup);$THIS.find('.smapp-slides-ct').empty();DATA.markergroup=_getMarkerLayer();DATA.map.addLayer(DATA.markergroup);DATA.items=[];DATA.index=null;_refreshControls();DATA.map.setView(DATA.options.center,DATA.options.zoom);},move:function(index,animate){if(DATA.frozen)return;if(!methods.get(index))return;if($THIS.triggerHandler('move',[methods.get(index),index])===false)return;if(animate){if(DATA.index!==null)_slideOut(DATA.items[DATA.index].$slide,(index>DATA.index));_slideIn(DATA.items[index].$slide,(index>DATA.index));}
else{if(DATA.index!==null)DATA.items[DATA.index].$slide.removeClass('active');DATA.items[index].$slide.addClass('active');_autoHeight(DATA.items[0].$slide,false);}
_showPopup(DATA.items[index],animate);DATA.index=index;_refreshControls();},next:function(){methods.move(DATA.index===null?0:DATA.index+1,true);},prev:function(){methods.move(DATA.index===null?0:DATA.index-1,true);}};$.fn.slideMapper=function(method){if(this.length>1){$.error('SlideMapper currently only supports 1 map per page');}
else if(method&&typeof method!=='object'&&!methods[method]){$.error('Method '+method+' does not exist on jQuery.slideMapper');}
else{var ret=null;for(var i=0;i<this.length;i++){$THIS=$(this[i]);DATA=$THIS.data('slideMapper');if(methods[method]){if(!DATA)$.error('Method '+method+' called on uninitialized element');else ret=methods[method].apply(this[i],Array.prototype.slice.call(arguments,1));}
else{methods.init.apply(this[i],arguments);}
$THIS.data('slideMapper',DATA);}
return(ret===null?this:ret);}};})(jQuery);